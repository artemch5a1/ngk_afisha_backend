name: Docker Build + Healthcheck

on:
  pull_request:
    branches:
      - main

jobs:
  docker-build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Compose v2
        uses: docker/setup-buildx-action@v3

      - name: Copy .env.example
        working-directory: ngk_afisha_backend/services
        run: |
          cp .env.example .env

      - name: Build Docker Compose services
        working-directory: ngk_afisha_backend/services
        run: |
          echo "üì¶ Building all containers..."
          docker compose -f compose/all.yml build

      - name: Start containers for healthcheck
        working-directory: ngk_afisha_backend/services
        run: |
          echo "üöÄ Starting containers..."
          docker compose -f compose/all.yml up -d

      - name: Run healthchecks
        working-directory: ngk_afisha_backend/services
        run: |
          echo "ü©∫ Checking container health..."
          unhealthy=$(docker ps --filter "health=unhealthy" --format "{{.Names}}")
          if [ -n "$unhealthy" ]; then
            echo "‚ùå Unhealthy containers: $unhealthy"
            docker compose -f compose/all.yml logs
            exit 1
          fi
          echo "‚úÖ All containers healthy"

      - name: Tear down containers
        working-directory: ngk_afisha_backend/services
        if: always()
        run: |
          docker compose -f compose/all.yml down -v
